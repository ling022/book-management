<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bookmanagement.dao.BookMapper">

    <resultMap id="BookResultMap" type="Book">
        <id property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="author" column="author"/>
        <result property="isbn" column="isbn"/>
        <result property="publisher" column="publisher"/>
        <result property="publishDate" column="publish_date"/>
        <result property="category" column="category"/>
        <result property="description" column="description"/>
        <result property="totalCopies" column="total_copies"/>
        <result property="availableCopies" column="available_copies"/>
        <result property="status" column="status"/>
        <result property="createdTime" column="created_time"/>
        <result property="imagePath" column="image_path"/> <!-- 新增 -->
    </resultMap>

    <insert id="insertBook" parameterType="Book" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO books (title, author, isbn, publisher, publish_date, category,
                          description, total_copies, available_copies, status, image_path)
        VALUES (#{title}, #{author}, #{isbn}, #{publisher}, #{publishDate}, #{category},
                #{description}, #{totalCopies}, #{availableCopies}, #{status}, #{imagePath})
    </insert>

    <delete id="deleteBook" parameterType="int">
        DELETE FROM books WHERE id = #{id}
    </delete>

    <update id="updateBook" parameterType="Book">
        UPDATE books
        SET title = #{title},
            author = #{author},
            isbn = #{isbn},
            publisher = #{publisher},
            publish_date = #{publishDate},
            category = #{category},
            description = #{description},
            total_copies = #{totalCopies},
            available_copies = #{availableCopies},
            status = #{status},
            image_path = #{imagePath}
        WHERE id = #{id}
    </update>

    <select id="selectBookById" parameterType="int" resultMap="BookResultMap">
        SELECT * FROM books WHERE id = #{id}
    </select>

    <select id="selectAllBooks" resultMap="BookResultMap">
        SELECT * FROM books ORDER BY created_time DESC
    </select>

    <select id="selectBooksByCondition" resultMap="BookResultMap">
        SELECT * FROM books
        WHERE 1=1
        <if test="keyword != null and keyword != ''">
            AND (title LIKE CONCAT('%', #{keyword}, '%')
            OR author LIKE CONCAT('%', #{keyword}, '%')
            OR isbn LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        <if test="category != null and category != ''">
            AND category = #{category}
        </if>
        ORDER BY created_time DESC
    </select>

    <select id="selectBookByIsbn" parameterType="string" resultMap="BookResultMap">
        SELECT * FROM books WHERE isbn = #{isbn}
    </select>

    <select id="countBooks" resultType="int">
        SELECT COUNT(*) FROM books
    </select>

    <update id="updateAvailableCopies">
        UPDATE books
        SET available_copies = #{availableCopies},
            status = CASE
                WHEN #{availableCopies} > 0 THEN 'AVAILABLE'
                ELSE 'BORROWED'
            END
        WHERE id = #{id}
    </update>

    <select id="selectBooksByPage" resultMap="BookResultMap">
        SELECT * FROM books
        ORDER BY created_time DESC
        LIMIT #{start}, #{pageSize}
    </select>

</mapper>